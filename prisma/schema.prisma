// Prisma Schema for RJL-Backend
// Generated from existing PostgreSQL database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Region {
  EAST
  SOUTH
  WEST
  NORTH
  CENTRAL
}

// ==================== MODELS ====================

model Agency {
  id            Int       @id @default(autoincrement())
  agencyName    String    @map("agency_name") @db.VarChar(255)
  address       String?
  phone         String?   @db.VarChar(50)
  logo          String?
  isActive      Boolean?  @default(true) @map("is_active")
  veuActivated  Boolean?  @default(false) @map("veu_activated")
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  whitelist AgencyWhitelist[]
  users     User[]
  tasks     Task[]

  @@map("AGENCY")
}

model AgencyWhitelist {
  id           Int       @id @default(autoincrement())
  agencyId     Int       @map("agency_id")
  emailAddress String    @map("email_address") @db.VarChar(255)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  agency Agency @relation(fields: [agencyId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_agency")

  @@map("AGENCY_WHITELIST")
}

model Contact {
  id         Int       @id @default(autoincrement())
  name       String    @db.VarChar(255)
  phone      String?   @db.VarChar(100)
  email      String?   @db.VarChar(255)
  isActive   Boolean?  @default(true) @map("is_active")
  propertyId Int?      @map("property_id")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  property                Property?                @relation(fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_property")
  inspectionBookings      InspectionBooking[]
  inspectionNotifications InspectionNotification[]

  @@map("CONTACT")
}

model Email {
  id          Int       @id @default(autoincrement())
  subject     String?
  sender      String?
  recipient   String?   @map("recipient")  // Recipient email (for outbound emails)
  emailBody   String?   @map("email_body")
  html        String?
  agencyId    Int?      @map("agency_id")
  gmailMsgid  String?   @unique @map("gmail_msgid") @db.VarChar(64)
  isProcessed Boolean   @default(false) @map("is_processed")
  processNote String?   @map("process_note")
  direction   String?   @default("inbound") @map("direction") @db.VarChar(20)  // "inbound" | "outbound"
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  properties Property[] @relation("EmailProperties")
  tasks      Task[]

  @@map("EMAIL")
}

model Permission {
  id              Int    @id(map: "permission_pkey") @default(autoincrement())
  permissionValue String @map("permission_value") @db.VarChar(50)
  permissionScope String @map("permission_scope") @db.VarChar(50)

  // Relations
  userPermissions UserPermission[]

  @@map("PERMISSION")
}

model Property {
  id        Int       @id @default(autoincrement())
  address   String?
  userId    Int       @map("user_id")
  region    Region?   // 区域: 东/南/西/北/中
  isActive  Boolean?  @default(true) @map("is_active")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  user                    User                     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_user")
  contacts                Contact[]
  emails                  Email[]                  @relation("EmailProperties")
  tasks                   Task[]
  veuProjects             VeuProject[]
  inspectionBookings      InspectionBooking[]
  inspectionNotifications InspectionNotification[]

  @@index([region], map: "idx_property_region")
  @@map("PROPERTY")
}

model SystemSettings {
  id            Int       @id @default(autoincrement())
  emailHost     String?   @map("email_host")
  googleMapKey  String?   @map("google_map_key")
  emailUser     String?   @map("email_user") @db.VarChar(255)
  emailPassword String?   @map("email_password") @db.VarChar(255)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@map("SYSTEM_SETTINGS")
}

model Task {
  id                 Int       @id @default(autoincrement())
  propertyId         Int       @map("property_id")
  dueDate            DateTime? @map("due_date") @db.Timestamp(6)
  taskName           String?   @map("task_name") @db.VarChar(255)
  taskDescription    String?   @map("task_description")
  repeatFrequency    String?   @default("none") @map("repeat_frequency") @db.VarChar(20)
  inspectionDate     DateTime? @map("inspection_date") @db.Timestamp(6)
  type               String?   @db.VarChar(255)
  status             String?   @default("unknown") @db.VarChar(20)
  isActive           Boolean?  @default(true) @map("is_active")
  emailId            Int?      @map("email_id")
  agencyId           Int       @map("agency_id")
  freeCheckAvailable Boolean?  @default(false) @map("free_check_available")
  createdAt          DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  property           Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_property")
  email              Email?              @relation(fields: [emailId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_email")
  agency             Agency              @relation(fields: [agencyId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_agency")
  files              TaskFile[]
  inspectionBookings InspectionBooking[]

  @@map("TASK")
}

model TaskFile {
  id        Int       @id @default(autoincrement())
  taskId    Int       @map("task_id")
  fileS3Key String    @map("file_s3_key") @db.VarChar(255)
  fileName  String    @map("file_name") @db.VarChar(255)
  fileDesc  String?   @map("file_desc")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_task")

  @@map("TASK_FILES")
}

model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique @db.VarChar(255)
  name              String?   @db.VarChar(255)
  password          String    @db.VarChar(255)
  role              String    @db.VarChar(50)
  isActive          Boolean   @default(true) @map("is_active")
  refreshToken      String?   @map("refresh_token")
  resetToken        String?   @map("reset_token") @db.VarChar(64)
  resetTokenExpires DateTime? @map("reset_token_expires") @db.Timestamptz(6)
  agencyId          Int?      @map("agency_id")
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  agency                     Agency?                  @relation(fields: [agencyId], references: [id], onUpdate: NoAction, map: "fk_agency")
  properties                 Property[]
  permissions                UserPermission[]
  createdInspectionSchedules InspectionSchedule[]     @relation("ScheduleCreator")
  confirmedBookings          InspectionBooking[]      @relation("BookingConfirmer")
  bookedInspections          InspectionBooking[]      @relation("BookingMadeBy")
  notificationsReceived      InspectionNotification[]

  @@map("USER")
}

model UserPermission {
  userId       Int @map("user_id")
  permissionId Int @map("permission_id")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "user_permission_fk_user_id")
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "user_permission_fk_permission_id")

  @@id([userId, permissionId], map: "user_permission_pkey")
  @@map("USER_PERMISSION")
}

/// This table contains check constraints and requires additional setup for migrations.
model VeuProject {
  id          Int       @id @default(autoincrement())
  propertyId  Int       @map("property_id")
  type        String?   @db.VarChar(50)
  isCompleted Boolean?  @default(false) @map("is_completed")
  price       Decimal?  @db.Decimal(10, 2)
  completedBy String?   @map("completed_by") @db.VarChar(255)
  note        String?
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  property Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  files    VeuProjectFile[]

  @@unique([propertyId, type], map: "idx_veu_project_property_type_unique")
  @@map("VEU_PROJECT")
}

model VeuProjectFile {
  id           Int       @id @default(autoincrement())
  veuProjectId Int       @map("veu_project_id")
  fileS3Key    String    @map("file_s3_key") @db.VarChar(500)
  fileName     String    @map("file_name") @db.VarChar(255)
  fileDesc     String?   @default("") @map("file_desc")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  veuProject VeuProject @relation(fields: [veuProjectId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "veu_project_files_veu_project_id_fkey")

  @@index([createdAt(sort: Desc)], map: "idx_veu_project_files_created_at")
  @@index([veuProjectId], map: "idx_veu_project_files_project_id")
  @@map("VEU_PROJECT_FILES")
}

// ==================== INSPECTION SYSTEM ====================

// 区域检查配置表 - 每个区域的时间规则
model InspectionConfig {
  id           Int       @id @default(autoincrement())
  region       Region    @unique
  startTime    String    @map("start_time") @db.VarChar(5)  // "08:30"
  endTime      String    @map("end_time") @db.VarChar(5)    // "18:30"
  slotDuration Int       @map("slot_duration")              // 分钟数，如150
  maxCapacity  Int       @default(1) @map("max_capacity")   // 每时段最大预约数
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("INSPECTION_CONFIG")
}

// 检查计划表 - 发布的检查日程
model InspectionSchedule {
  id           Int       @id @default(autoincrement())
  region       Region
  scheduleDate DateTime  @map("schedule_date") @db.Date
  startTime    String    @map("start_time") @db.VarChar(5)
  endTime      String    @map("end_time") @db.VarChar(5)
  slotDuration Int       @map("slot_duration")
  maxCapacity  Int       @default(1) @map("max_capacity")
  status       String    @default("published") @db.VarChar(20) // published, closed
  note         String?
  createdBy    Int       @map("created_by")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  creator       User                     @relation("ScheduleCreator", fields: [createdBy], references: [id])
  slots         InspectionSlot[]
  notifications InspectionNotification[]

  @@unique([region, scheduleDate], map: "idx_schedule_region_date")
  @@index([scheduleDate], map: "idx_schedule_date")
  @@map("INSPECTION_SCHEDULE")
}

// 检查时间段表 - 自动生成的可预约时段
model InspectionSlot {
  id              Int       @id @default(autoincrement())
  scheduleId      Int       @map("schedule_id")
  startTime       String    @map("start_time") @db.VarChar(5)
  endTime         String    @map("end_time") @db.VarChar(5)
  maxCapacity     Int       @default(1) @map("max_capacity")
  currentBookings Int       @default(0) @map("current_bookings")
  isAvailable     Boolean   @default(true) @map("is_available")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  schedule InspectionSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  bookings InspectionBooking[]

  @@index([scheduleId, isAvailable], map: "idx_slot_schedule_available")
  @@map("INSPECTION_SLOT")
}

// 预约记录表 - 客户的预约
model InspectionBooking {
  id             Int       @id @default(autoincrement())
  slotId         Int       @map("slot_id")
  propertyId     Int       @map("property_id")
  taskId         Int?      @map("task_id")
  contactId      Int?      @map("contact_id")
  contactName    String    @map("contact_name") @db.VarChar(255)
  contactPhone   String?   @map("contact_phone") @db.VarChar(100)
  contactEmail   String?   @map("contact_email") @db.VarChar(255)
  status         String    @default("pending") @db.VarChar(20) // pending, confirmed, rejected, cancelled
  note           String?
  bookingToken   String    @unique @map("booking_token") @db.VarChar(64)
  tokenExpiresAt DateTime  @map("token_expires_at") @db.Timestamptz(6) // 14天后过期
  confirmedBy    Int?      @map("confirmed_by")
  confirmedAt    DateTime? @map("confirmed_at") @db.Timestamptz(6)
  bookedByUserId Int?      @map("booked_by_user_id")  // 预约的agency用户ID
  bookerType     String?   @map("booker_type") @db.VarChar(20) // 'contact' 或 'agencyUser'
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  slot         InspectionSlot @relation(fields: [slotId], references: [id])
  property     Property       @relation(fields: [propertyId], references: [id])
  task         Task?          @relation(fields: [taskId], references: [id])
  contact      Contact?       @relation(fields: [contactId], references: [id])
  confirmer    User?          @relation("BookingConfirmer", fields: [confirmedBy], references: [id])
  bookedByUser User?          @relation("BookingMadeBy", fields: [bookedByUserId], references: [id])

  @@index([bookingToken], map: "idx_booking_token")
  @@index([propertyId], map: "idx_booking_property")
  @@index([status], map: "idx_booking_status")
  @@map("INSPECTION_BOOKING")
}

// 通知记录表 - 发送的邮件记录
model InspectionNotification {
  id             Int       @id @default(autoincrement())
  scheduleId     Int       @map("schedule_id")
  propertyId     Int       @map("property_id")
  contactId      Int?      @map("contact_id")
  userId         Int?      @map("user_id")               // agency用户ID
  recipientType  String?   @map("recipient_type") @db.VarChar(20) // 'contact' 或 'agencyUser'
  recipientEmail String    @map("recipient_email") @db.VarChar(255)
  bookingToken   String    @map("booking_token") @db.VarChar(64)
  status         String    @default("sent") @db.VarChar(20) // sent, delivered, failed
  sentAt         DateTime? @default(now()) @map("sent_at") @db.Timestamptz(6)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  schedule InspectionSchedule @relation(fields: [scheduleId], references: [id])
  property Property           @relation(fields: [propertyId], references: [id])
  contact  Contact?           @relation(fields: [contactId], references: [id])
  user     User?              @relation(fields: [userId], references: [id])

  @@index([scheduleId], map: "idx_notification_schedule")
  @@index([bookingToken], map: "idx_notification_token")
  @@index([propertyId, recipientEmail], map: "idx_notification_property_email")
  @@map("INSPECTION_NOTIFICATION")
}
